pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:latest
    command:
    - cat
    tty: true
    volumeMounts:
    - name: docker-config
      mountPath: /kaniko/.docker
  - name: git
    image: alpine/git:latest
    command:
    - cat
    tty: true
  volumes:
  - name: docker-config
    emptyDir: {}
"""
        }
    }
    
    environment {
        AWS_REGION = 'us-east-1'
        ECR_REPOSITORY = "${params.ECR_REPOSITORY ?: ''}"
        GIT_REPO = sh(script: 'git config --get remote.origin.url', returnStdout: true).trim()
        GIT_BRANCH = env.BRANCH_NAME ?: 'main'
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        HELM_CHART_PATH = 'charts/django-app'
    }
    
    parameters {
        string(name: 'ECR_REPOSITORY', defaultValue: '', description: 'ECR Repository URL (get from: terraform -chdir=.. output -raw ecr_repository_url)')
    }
    
    stages {
        stage('Checkout') {
            steps {
                container('git') {
                    checkout scm
                }
            }
        }
        
        stage('Build and Push Docker Image') {
            when {
                expression { env.ECR_REPOSITORY != '' }
            }
            steps {
                container('kaniko') {
                    script {
                        sh """
                        /kaniko/executor \
                            --context=./Django \
                            --dockerfile=./Django/Dockerfile \
                            --destination=${ECR_REPOSITORY}:${IMAGE_TAG} \
                            --destination=${ECR_REPOSITORY}:latest \
                            --cache=true
                        """
                    }
                }
            }
        }
        
        stage('Update Helm Chart') {
            when {
                expression { env.ECR_REPOSITORY != '' }
            }
            steps {
                container('git') {
                    script {
                        sh """
                        git config user.name 'Jenkins'
                        git config user.email 'jenkins@example.com'
                        
                        # Update values.yaml with new image tag
                        sed -i "s|tag:.*|tag: \"${IMAGE_TAG}\"|g" ${HELM_CHART_PATH}/values.yaml
                        sed -i "s|repository:.*|repository: ${ECR_REPOSITORY}|g" ${HELM_CHART_PATH}/values.yaml
                        
                        # Commit changes (push requires Git credentials to be configured in Jenkins)
                        git add ${HELM_CHART_PATH}/values.yaml
                        git commit -m "Update image tag to ${IMAGE_TAG}" || echo "No changes to commit"
                        
                        # Try to push (will fail if credentials not configured, but that's OK for demo)
                        git push origin ${GIT_BRANCH} || echo "Note: Git push requires credentials. Configure Git credentials in Jenkins for automatic push."
                        """
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo "Pipeline succeeded! Image ${ECR_REPOSITORY}:${IMAGE_TAG} pushed and Helm chart updated."
        }
        failure {
            echo "Pipeline failed!"
        }
    }
}

